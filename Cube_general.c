#include "Cube_general.h"

repeating_timer_t timer_moving_layer;
repeating_timer_t timer_rock;
repeating_timer_t timer_paper;
repeating_timer_t timer_scissors;

uint8_t temp[8][8] = {{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        };

uint8_t layer[8][8] = {{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        };

uint8_t paper[8][8] = {{0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xC3, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        };   
                        
uint8_t rock[8][8] = {{0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF},
                        };
                        
uint8_t scissors[8][8] = {{0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF},
                        {0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xC3, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xFF, 0xC3, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xFF, 0xC3, 0xFF, 0xFF, 0xFF},
                        {0xFF, 0xFF, 0xC3, 0xFF, 0xC3, 0xFF, 0xFF, 0xFF},
                        }; 

void cube_init() {
    // SPI initialisation. This example will use SPI at 1MHz.
    spi_init(SPI_PORT, 100000);
    gpio_set_function(PIN_TX, GPIO_FUNC_SPI);
    gpio_set_function(PIN_SCK,  GPIO_FUNC_SPI);

    // GPIO initialization.
    gpio_init(PIN_RCLK);
    gpio_set_dir(PIN_RCLK, GPIO_OUT);
    gpio_put(PIN_RCLK, DATA_LOW);       // set to low

    for (int i = 0; i < 8; i++) {
        gpio_init(PIN_BASED_LAYER + i);
        gpio_set_dir(PIN_BASED_LAYER + i, GPIO_OUT);
        gpio_put(PIN_BASED_LAYER + i, 0);      // set to low
    }
}

bool timer_callback_moving_layer(repeating_timer_t *rt) {
    input_all(layer);
    return true;
}

bool timer_callback_rock(repeating_timer_t *rt) {
    input_all(rock);
    return true;
}

bool timer_callback_paper(repeating_timer_t *rt) {
    input_all(paper);
    return true;
}

bool timer_callback_scissors(repeating_timer_t *rt) {
    input_all(scissors);
    return true;
}

void input_all(uint8_t cube[8][8]) {
    int i;

    for (i = 0; i < 8; i++) {
        spi_write_blocking(SPI_PORT, cube[i], 8);

        gpio_put(PIN_RCLK, 1);
        busy_wait_us(10);
        gpio_put(PIN_RCLK, 0);

        gpio_put(PIN_BASED_LAYER + i, 1);
        busy_wait_us(300);
        gpio_put(PIN_BASED_LAYER + i, 0);
    }
}

void moving_layer() {
    int i;
    uint8_t one_layer[8] = {0};

    for (i = 0; i < 8; i++)
    {
        memcpy(layer[i], one_layer, sizeof(one_layer));
        add_repeating_timer_ms(16, timer_callback_moving_layer, NULL, &timer_moving_layer);
        sleep_ms(500);
        bool cancelled = cancel_repeating_timer(&timer_moving_layer);
        memcpy(layer, temp, sizeof(temp));
    }
    
}